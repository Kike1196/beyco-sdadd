package com.beyco.app.services;

import com.beyco.app.models.CursoInstructor;
import com.beyco.app.models.Alumno;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import java.sql.*;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

@Service
public class CursoInstructorService {

    private final Connection connection;

    @Autowired
    public CursoInstructorService(Connection connection) {
        this.connection = connection;
    }

    public List<CursoInstructor> getCursosByInstructor(int instructorId) {
        List<CursoInstructor> cursos = new ArrayList<>();
        String sql = "SELECT * FROM cursos WHERE Id_Instructor = ? ORDER BY Fecha_Inicio DESC";
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            pstmt.setInt(1, instructorId);
            ResultSet rs = pstmt.executeQuery();
            while (rs.next()) {
                cursos.add(mapRowToCursoInstructor(rs));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return cursos;
    }

    public CursoInstructor getCursoInstructorById(int cursoId) {
        String sql = "SELECT * FROM cursos WHERE Id_Curso = ?";
        try (PreparedStatement pstmt = connection.prepareStatement(sql)) {
            pstmt.setInt(1, cursoId);
            ResultSet rs = pstmt.executeQuery();
            if (rs.next()) {
                return mapRowToCursoInstructor(rs);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return null;
    }
    
    // ... (Aquí irían los otros métodos como getEstadisticas, getAlumnos, etc., que definimos previamente)

    private CursoInstructor mapRowToCursoInstructor(ResultSet rs) throws SQLException {
        CursoInstructor curso = new CursoInstructor();
        curso.setId(rs.getInt("Id_Curso"));
        curso.setNombre(rs.getString("Nombre_Curso"));
        Date fechaSql = rs.getDate("Fecha_Inicio");
        if (fechaSql != null) {
            curso.setFecha(fechaSql.toLocalDate());
        }
        curso.setEmpresa(rs.getString("Empresa_Cliente"));
        curso.setLugar(rs.getString("Ubicacion"));
        curso.setStatus(rs.getString("Estado"));
        curso.setInstructorId(rs.getInt("Id_Instructor"));
        curso.setDescripcion(rs.getString("Descripcion"));
        curso.setDuracion(rs.getString("Duracion_Horas"));
        curso.setParticipantes(rs.getInt("Cupo_Maximo"));
        curso.setTipo(rs.getString("Modalidad"));
        curso.setCategoria(rs.getString("Categoria"));
        return curso;
    }

    private Alumno mapRowToAlumno(ResultSet rs) throws SQLException {
        Alumno alumno = new Alumno();
        alumno.setCurp(rs.getString("Curp"));
        alumno.setNombre(rs.getString("Nombre"));
        alumno.setApellidoPaterno(rs.getString("Apellido_paterno"));
        alumno.setApellidoMaterno(rs.getString("Apellido_materno"));
        // ... (resto del mapeo para Alumno)
        return alumno;
    }
}